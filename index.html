<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SOLEC · Panel Dueño</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700&family=Barlow+Condensed:wght@700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117; --surface:#1a1d27; --surface2:#22263a; --border:#2e3248;
  --rojo:#cc1a1a; --amarillo:#f5c800; --verde:#1a9a4a; --azul:#2a6adb;
  --text:#e8eaf0; --text2:#7a8099;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Barlow,sans-serif;background:var(--bg);color:var(--text)}
.top{position:sticky;top:0;z-index:50;background:var(--surface);border-bottom:1px solid var(--border)}
.topin{display:flex;justify-content:space-between;align-items:center;padding:12px 18px}
.logo{display:flex;align-items:center;gap:10px}
.mark{width:40px;height:40px;border-radius:50%;background:var(--rojo);display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 2px var(--amarillo)}
.logo h1{font-family:"Barlow Condensed";letter-spacing:.08em}
.logo h1 span{color:var(--amarillo)}
.logo p{font-size:11px;color:var(--text2);letter-spacing:.1em;text-transform:uppercase}
.wrap{max-width:980px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:14px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px}
.row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
.small{color:var(--text2);font-size:12px}
.h{font-weight:700}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;font-family:"Barlow Condensed";letter-spacing:.06em;text-transform:uppercase;cursor:pointer}
.btn.ok{background:var(--verde);color:#fff}
.btn.no{background:transparent;border:1px solid var(--rojo);color:var(--rojo)}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.badge{padding:3px 10px;border-radius:999px;font-weight:800;font-family:"Barlow Condensed";letter-spacing:.06em}
.bEn{background:#2a6adb22;border:1px solid #2a6adb44;color:var(--azul)}
.bAp{background:#1a9a4a22;border:1px solid #1a9a4a44;color:var(--verde)}
.bPe{background:#f5c80022;border:1px solid #f5c80044;color:var(--amarillo)}
.modalO{position:fixed;inset:0;background:#000a;display:none;align-items:flex-start;justify-content:center;padding:18px;overflow:auto;z-index:200}
.modal{width:100%;max-width:780px;background:var(--surface);border:1px solid var(--border);border-radius:16px}
.mh{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.mb{padding:18px}
.ta{width:100%;height:110px;border-radius:12px;border:1px solid var(--border);background:var(--surface2);color:var(--text);padding:10px;outline:none;resize:none}
.total{font-family:"Barlow Condensed";font-weight:800;font-size:28px;color:var(--verde)}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
</style>
</head>
<body>
<div class="top">
  <div class="topin">
    <div class="logo">
      <div class="mark">⚡</div>
      <div>
        <h1>SOL<span>EC</span>®</h1>
        <p>Panel dueño · Aprobaciones</p>
      </div>
    </div>
    <button class="btn ghost" onclick="cargar()">↻ Actualizar</button>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <div class="h">PARA APROBAR <span class="badge bEn" id="bEn">0</span></div>
        <div class="small">Registros que Ciro ya costeó y te envió.</div>
      </div>
      <div class="small">Estados: Pendiente / Enviado / Aprobado / Rechazado</div>
    </div>
  </div>

  <div id="lista" class="small">Cargando…</div>
</div>

<div class="modalO" id="modalO">
  <div class="modal">
    <div class="mh">
      <div>
        <div class="h" id="mt">Registro</div>
        <div class="small" id="ms"></div>
      </div>
      <button class="btn ghost" onclick="cerrar()">✕</button>
    </div>
    <div class="mb">
      <div class="small">Resumen ARCA</div>
      <div class="card" style="margin-top:8px;background:var(--surface2)">
        <div id="mRes" style="white-space:pre-wrap"></div>
      </div>

      <hr>

      <div class="row">
        <div>
          <div class="small">MO</div>
          <div class="h" id="mMO">$0</div>
        </div>
        <div>
          <div class="small">Materiales</div>
          <div class="h" id="mMAT">$0</div>
        </div>
        <div>
          <div class="small">Total</div>
          <div class="total" id="mT">$0</div>
        </div>
      </div>

      <hr>

      <div class="small">Si devolvés con nota, vuelve a Ciro como <b>Pendiente</b>.</div>
      <textarea class="ta" id="nota" placeholder="Escribí qué falta o qué cambiar…"></textarea>

      <div class="row" style="margin-top:12px">
        <button class="btn no" onclick="rechazar()">Devolver con nota</button>
        <button class="btn ok" onclick="aprobar()">Aprobar</button>
      </div>
    </div>
  </div>
</div>

<script>
const SHEETDB_URL = "https://sheetdb.io/api/v1/pqo4oljkpi6dj";
let registros = [];
let actual = null;

function money(n){ n = Number(n||0); return "$" + n.toLocaleString("es-AR"); }

async function cargar(){
  document.getElementById("lista").textContent = "Cargando…";
  const res = await fetch(SHEETDB_URL + "?sheet=Registros");
  const data = await res.json();

  registros = data.map(r=>({
    id: String(r["ID"]||"").trim(),
    fecha: r["Fecha"]||"",
    edificio: r["Edificio"]||"",
    tipo: r["Tipo de Visita"]||"",
    estado: String(r["Estado"]||"Pendiente").trim(),
    resumen: String(r["Resumen ARCA"]||"").trim(),
    mo: Number(r["Total MO"]||0),
    mat: Number(r["Total MAT"]||0),
    total: Number(r["Total"]||0),
  })).filter(r=>r.id);

  const enviados = registros.filter(r=>r.estado==="Enviado");
  document.getElementById("bEn").textContent = enviados.length;

  if(enviados.length===0){
    document.getElementById("lista").innerHTML = `<div class="card small">Sin registros para aprobar.</div>`;
    return;
  }

  document.getElementById("lista").innerHTML = enviados.map(r=>`
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <div class="h">${r.edificio}</div>
          <div class="small">${r.fecha} · ${r.tipo} · <span class="badge bEn">Enviado</span></div>
          <div class="small" style="margin-top:8px;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${(r.resumen||"").replace(/\n/g," · ")}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="h">${money(r.total)}</div>
          <button class="btn ghost" onclick="openModal('${r.id}')">Ver</button>
        </div>
      </div>
    </div>
  `).join("");
}

function openModal(id){
  actual = registros.find(r=>r.id===id);
  if(!actual) return;

  document.getElementById("mt").textContent = actual.edificio || "Registro";
  document.getElementById("ms").textContent = `${actual.fecha} · ${actual.tipo} · Estado: ${actual.estado}`;
  document.getElementById("mRes").textContent = actual.resumen || "—";
  document.getElementById("mMO").textContent = money(actual.mo);
  document.getElementById("mMAT").textContent = money(actual.mat);
  document.getElementById("mT").textContent = money(actual.total);
  document.getElementById("nota").value = "";

  document.getElementById("modalO").style.display="flex";
}

function cerrar(){
  document.getElementById("modalO").style.display="none";
  actual = null;
}

async function patchActual(data){
  const url = `${SHEETDB_URL}/ID/${encodeURIComponent(actual.id)}?sheet=Registros`;
  const res = await fetch(url,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data })
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
}

async function aprobar(){
  if(!actual) return;
  try{
    await patchActual({ "Estado":"Aprobado", "Nota Dueno": "" });
    alert("Aprobado ✅");
    cerrar();
    cargar();
  }catch(e){
    console.error(e);
    alert("Error aprobando.");
  }
}

async function rechazar(){
  if(!actual) return;
  const nota = document.getElementById("nota").value.trim();
  if(!nota) return alert("Escribí una nota.");
  try{
    await patchActual({ "Estado":"Pendiente", "Nota Dueno": nota });
    alert("Devuelto a Ciro con nota ✅");
    cerrar();
    cargar();
  }catch(e){
    console.error(e);
    alert("Error devolviendo.");
  }
}

cargar();
</script>
</body>
</html>
